<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de TrÃ¡fego</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../static/styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body  class="bg-custom">

<div class="container py-5">

    <ul class="nav nav-pills nav-fill gap-2 p-1 small bg-dark rounded-5 shadow-sm" id="pillNav2" role="tablist" style="--bs-nav-link-color: var(--bs-white); --bs-nav-pills-link-active-color: var(--bs-primary); --bs-nav-pills-link-active-bg: var(--bs-white);">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-5" id="home-tab2" data-bs-toggle="tab" type="button" role="tab" aria-selected="true">Consumo em tempo real</button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link rounded-5" id="profile-tab2" href="{{ url_for('report') }}" type="button" role="tab" aria-selected="false">RelatÃ³rio de consumo</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link rounded-5" id="contact-tab2" href="{{ url_for('dashboard') }}" type="button" role="tab" aria-selected="false">Dashboard</a>
        </li>
    </ul>
    <br/>

    <h2 class="text-center mb-4">ðŸ“Š Monitor de TrÃ¡fego da Rede</h2>

    <!-- Linha de Cards -->
    <div class="row mb-4 text-center">
        <!-- Card 1 -->
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Taxa MÃ©dia</h6>
                    <p class="display-6">
                        <span id="avg-download">0</span> / 
                        <span id="avg-upload">0</span> Mbps
                    </p>
                    <small class="text-muted">Upload / Download</small>
                </div>
            </div>
        </div>
        <!-- Card 2 -->
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Pico</h6>
                    <p class="display-6">
                        <span id="peak-download">0</span> / 
                        <span id="peak-upload">0</span> Mbps
                    </p>
                    <small class="text-muted">Upload / Download</small>
                </div>
            </div>
        </div>
        <!-- Card 3 -->
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Total Acumulado</h6>
                    <p class="display-6">
                        <span id="total-download">0</span> / 
                        <span id="total-upload">0</span> MB
                    </p>
                    <small class="text-muted">Upload / Download</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Card com grÃ¡fico -->
    <div class="card shadow">
        <div class="card-body">
            <h5 class="card-title text-center">Consumo em tempo real (Mbps)</h5>
            <div style="max-width: 900px; height: 400px; margin: auto;">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>

    const ctx = document.getElementById('trafficChart').getContext('2d');
    const trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Upload (Mbps)',
                    data: [],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.3
                },
                {
                    label: 'Download (Mbps)',
                    data: [],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // VariÃ¡veis de cÃ¡lculo
    let allDownloads = [];
    let allUploads = [];

    async function fetchData() {
        const res = await fetch('/data');
        const data = await res.json();
        const now = new Date().toLocaleTimeString();

        trafficChart.data.labels.push(now);
        trafficChart.data.datasets[0].data.push(data.download_mbps);
        trafficChart.data.datasets[1].data.push(data.upload_mbps);

        allDownloads.push(data.download_mbps);
        allUploads.push(data.upload_mbps);

        if (trafficChart.data.labels.length > 12) {
            trafficChart.data.labels.shift();
            trafficChart.data.datasets[0].data.shift();
            trafficChart.data.datasets[1].data.shift();
        }

        trafficChart.update();

        // CÃ¡lculos dos cards
        const avgDown = (allDownloads.reduce((a, b) => a + b, 0) / allDownloads.length).toFixed(2);
        const avgUp = (allUploads.reduce((a, b) => a + b, 0) / allUploads.length).toFixed(2);
        const peakDown = Math.max(...allDownloads).toFixed(2);
        const peakUp = Math.max(...allUploads).toFixed(2);
        const totalDown = ((allDownloads.reduce((a, b) => a + b, 0) * 5) / 8).toFixed(2); // MB aproximados (cada dado = mÃ©dia de 5s)
        const totalUp = ((allUploads.reduce((a, b) => a + b, 0) * 5) / 8).toFixed(2);

        document.getElementById('avg-download').innerText = avgDown;
        document.getElementById('avg-upload').innerText = avgUp;
        document.getElementById('peak-download').innerText = peakDown;
        document.getElementById('peak-upload').innerText = peakUp;
        document.getElementById('total-download').innerText = totalDown;
        document.getElementById('total-upload').innerText = totalUp;
    }

    setInterval(fetchData, 5000); // coleta a cada 5s
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
